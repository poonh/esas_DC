<!DOCTYPE html>
<head>
    <meta charset="utf-8"/>
    <link rel="dns-prefetch preconnect" href="https://u.jimcdn.com/" crossorigin="anonymous"/>
    <link rel="dns-prefetch preconnect" href="https://assets.jimstatic.com/" crossorigin="anonymous"/>
    <link rel="dns-prefetch preconnect" href="https://image.jimcdn.com" crossorigin="anonymous"/>
    <link rel="dns-prefetch preconnect" href="https://fonts.jimstatic.com" crossorigin="anonymous"/>
    <link rel="dns-prefetch preconnect" href="https://www.google-analytics.com" crossorigin="anonymous"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="description" content=""/>
    <meta name="robots" content="index, follow, archive"/>
    <meta property="st:section" content=""/>
 
    <title>ESAS Deconstruction</title>
 


    <style>
    html, body {
        margin:0
    }

    .hidden {
        display:none
    }

    .n {
        padding:5px
    }

    #emotion-header {
        position:relative
    }

    #emotion-header-logo, #emotion-header-title {
        position: absolute
    }
    </style>

    <link href="https://u.jimcdn.com/cms/o/s1c71c378b473a4b7/layout/l18102fdb581481be/css/main.css?t=1678435519" rel="stylesheet" type="text/css" id="jimdo_main_css"/>
    <link href="https://u.jimcdn.com/cms/o/s1c71c378b473a4b7/layout/l18102fdb581481be/css/layout.css?t=1481798901" rel="stylesheet" type="text/css" id="jimdo_layout_css"/>
    <link href="https://u.jimcdn.com/cms/o/s1c71c378b473a4b7/layout/l18102fdb581481be/css/font.css?t=1678435519" rel="stylesheet" type="text/css" id="jimdo_font_css"/>
    <script>

      
    /* <![CDATA[ */
    /*!  loadCss [c]2014 @scottjehl, Filament Group, Inc.  Licensed MIT */
    window.loadCSS = window.loadCss = function(e, n, t) {
        var r,
            l = window.document,
            a = l.createElement("link");
        if (n)
            r = n;
        else {
            var i = (l.body || l.getElementsByTagName("head")[0]).childNodes;
            r = i[i.length - 1]
        }
        var o = l.styleSheets;
        a.rel = "stylesheet",
        a.href = e,
        a.media = "only x",
        r.parentNode.insertBefore(a, n ? r : r.nextSibling);
        var d = function(e) {
            for (var n = a.href, t = o.length; t--;)
                if (o[t].href === n)
                    return e.call(a);
            setTimeout(function() {
                d(e)
            })
        };
        return a.onloadcssdefined = d, d(function() {
            a.media = t || "all"
        }), a
    };
    window.onloadCSS = function(n, o) {
        n.onload = function() {
            n.onload = null,
            o && o.call(n)
        },
        "isApplicationInstalled" in navigator && "onloadcssdefined" in n && n.onloadcssdefined(o)
    } /* ]]> */
    </script>
    <script>
    // <![CDATA[
    onloadCSS(loadCss('https://assets.jimstatic.com/web_oldtemplate.css.484168258c63bd4f69a74e0370dc7ab9.css'), function() {
        this.id = 'jimdo_web_css';
    });
    // ]]>
    </script>
    <link href="https://assets.jimstatic.com/web_oldtemplate.css.484168258c63bd4f69a74e0370dc7ab9.css" rel="preload" as="style"/>
    <noscript>
        <link href="https://assets.jimstatic.com/web_oldtemplate.css.484168258c63bd4f69a74e0370dc7ab9.css" rel="stylesheet"/>
    </noscript>
    <script>
    //<![CDATA[
    var jimdoData = {
        "isTestserver": false,
        "isLcJimdoCom": false,
        "isJimdoHelpCenter": false,
        "isProtectedPage": false,
        "cstok": "",
        "cacheJsKey": "dc04b44e71947b5963ce6fc1404a2bb2ea23e742",
        "cacheCssKey": "dc04b44e71947b5963ce6fc1404a2bb2ea23e742",
        "cdnUrl": "https:\/\/assets.jimstatic.com\/",
        "minUrl": "https:\/\/assets.jimstatic.com\/app\/cdn\/min\/file\/",
        "authUrl": "https:\/\/a.jimdo.com\/",
        "webPath": "https:\/\/www.npokokoro.jp\/",
        "appUrl": "https:\/\/a.jimdo.com\/",
        "cmsLanguage": "ja_JP",
        "isFreePackage": false,
        "mobile": false,
        "isDevkitTemplateUsed": false,
        "isTemplateResponsive": false,
        "websiteId": "s1c71c378b473a4b7",
        "pageId": 912164772,
        "packageId": 2,
        "shop": {
            "deliveryTimeTexts": {
                "1": "\u304a\u5c4a\u3051\u65e5\u6570\uff1a1~3\u65e5",
                "2": "\u304a\u5c4a\u3051\u65e5\u6570\uff1a3~5\u65e5",
                "3": "\u304a\u5c4a\u3051\u65e5\u6570\uff1a5~8\u65e5"
            },
            "checkoutButtonText": "\u8cfc\u5165",
            "isReady": false,
            "currencyFormat": {
                "pattern": "\u00a4#,##0",
                "convertedPattern": "$#,##0",
                "symbols": {
                    "GROUPING_SEPARATOR": ",",
                    "DECIMAL_SEPARATOR": ".",
                    "CURRENCY_SYMBOL": "\uffe5"
                }
            },
            "currencyLocale": "ja_JP"
        },
        "tr": {
            "gmap": {
                "searchNotFound": "\u5165\u529b\u3055\u308c\u305f\u4f4f\u6240\u306f\u5b58\u5728\u3057\u306a\u3044\u304b\u3001\u898b\u3064\u3051\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002",
                "routeNotFound": "\u30eb\u30fc\u30c8\u304c\u8a08\u7b97\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u76ee\u7684\u5730\u304c\u9060\u3059\u304e\u308b\u304b\u660e\u78ba\u3067\u306f\u306a\u3044\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002"
            },
            "shop": {
                "checkoutSubmit": {
                    "next": "\u6b21\u3078",
                    "wait": "\u304a\u5f85\u3061\u304f\u3060\u3055\u3044"
                },
                "paypalError": "\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u518d\u5ea6\u304a\u8a66\u3057\u304f\u3060\u3055\u3044\u3002",
                "cartBar": "\u30b7\u30e7\u30c3\u30d4\u30f3\u30b0\u30ab\u30fc\u30c8\u3092\u78ba\u8a8d",
                "maintenance": "\u7533\u3057\u8a33\u3054\u3056\u3044\u307e\u305b\u3093\u3001\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u4e2d\u306e\u305f\u3081\u4e00\u6642\u7684\u306b\u30b7\u30e7\u30c3\u30d7\u304c\u5229\u7528\u3067\u304d\u307e\u305b\u3093\u3002\u3054\u8ff7\u60d1\u3092\u304a\u304b\u3051\u3057\u7533\u3057\u8a33\u3054\u3056\u3044\u307e\u305b\u3093\u304c\u3001\u304a\u6642\u9593\u3092\u3042\u3051\u3066\u518d\u5ea6\u304a\u8a66\u3057\u304f\u3060\u3055\u3044\u3002",
                "addToCartOverlay": {
                    "productInsertedText": "\u30ab\u30fc\u30c8\u306b\u5546\u54c1\u304c\u8ffd\u52a0\u3055\u308c\u307e\u3057\u305f",
                    "continueShoppingText": "\u8cb7\u3044\u7269\u3092\u7d9a\u3051\u308b",
                    "reloadPageText": "\u66f4\u65b0"
                },
                "notReadyText": "\u3053\u3061\u3089\u306e\u30b7\u30e7\u30c3\u30d7\u306f\u73fe\u5728\u6e96\u5099\u4e2d\u306e\u305f\u3081\u3054\u5229\u7528\u3044\u305f\u3060\u3051\u307e\u305b\u3093\u3002\u30b7\u30e7\u30c3\u30d7\u30aa\u30fc\u30ca\u30fc\u306f\u4ee5\u4e0b\u3092\u3054\u78ba\u8a8d\u304f\u3060\u3055\u3044\u3002https:\/\/help.jimdo.com\/hc\/ja\/articles\/115005521583",
                "numLeftText": "\u73fe\u5728\u3053\u306e\u5546\u54c1\u306f {:num} \u307e\u3067\u8cfc\u5165\u3067\u304d\u307e\u3059\u3002",
                "oneLeftText": "\u3053\u306e\u5546\u54c1\u306e\u5728\u5eab\u306f\u6b8b\u308a1\u70b9\u3067\u3059"
            },
            "common": {
                "timeout": "\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3044\u305f\u3057\u307e\u3057\u305f\u3002\u5f8c\u307b\u3069\u518d\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002"
            },
            "form": {
                "badRequest": "\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u5f8c\u307b\u3069\u6539\u3081\u3066\u304a\u8a66\u3057\u304f\u3060\u3055\u3044\u3002"
            }
        },
        "jQuery": "jimdoGen002",
        "isJimdoMobileApp": false,
        "bgConfig": null,
        "bgFullscreen": null,
        "responsiveBreakpointLandscape": 767,
        "responsiveBreakpointPortrait": 480,
        "copyableHeadlineLinks": false,
        "tocGeneration": false,
        "googlemapsConsoleKey": false,
        "loggingForAnalytics": false,
        "loggingForPredefinedPages": false,
        "isFacebookPixelIdEnabled": false,
        "userAccountId": "0c3325d1-6b0b-446f-bc3b-e47d8fbb0d02",
        "dmp": {
            "typesquareFontApiKey": "4L6CCYWjET8%3D",
            "typesquareFontApiScriptUrl": "\/\/code.typesquare.com\/static\/4L6CCYWjET8%253D\/ts105.js",
            "typesquareFontsAvailable": true
        }
    };
    // ]]>
    </script>

    <script type="text/javascript">
    window.CKIES_OPTIN = true;
    </script>
    <script type="text/javascript">
    if (document.cookie.indexOf('ga-disable-UA-24230777-25') != -1 || !window.CookieControl.isCookieAllowed('ga') || !window.CookieControl.isCookieAllowed('jimdo_analytics')) {
        window['ga-disable-UA-24230777-25'] = true;
    }
    </script>
    <script>
    (function(window) {
        'use strict';
        var regBuff = window.__regModuleBuffer = [];
        var regModuleBuffer = function() {
            var args = [].slice.call(arguments);
            regBuff.push(args);
        };
        if (!window.regModule) {
            window.regModule = regModuleBuffer;
        }
    })(window);
    </script>
    <script src="https://assets.jimstatic.com/web.js.12719f3724127512fa9f.js" async="true"></script>

</head>
<body class="body cc-page cc-page-index cc-indexpage cc-pagemode-default cc-content-parent" id="page-912164772">

    <div id="cc-inner" class="cc-content-parent">
        <div id="cc-tp-padding-container" class="cc-content-parent">
            <div id="cc-tp-container" class="cc-content-parent">

                <div id="cc-tp-header">

                </div>

                <div id="cc-tp-wrapper">

                    <div id="cc-tp-navigation">
                        <div id="cc-tp-nav-top"></div>
                        <div class="cc-tp-gutter">
                            <div data-container="navigation">
                                <div class="j-nav-variant-standard">
                                    <ul id="mainNav1" class="mainNav1">
                                        <li id="cc-nav-view-912164772">
                                          <a href="https://poonh.github.io/esas_DC/" class="current level_1">
<!--index page begins-->
                                                <span>HOME</span>
                                            </a>
                                        </li>
                                        <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/filter_SP.html" class="current level_1"> <!-- target="_blank"-->
                                                <span>Filtering for Soft Protons</span>
                                            </a>
                                        </li>
                                        <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/anol_ccd.html" class="current level_1">
                                                <span>Anomalous CCD Check</span>
                                            </a>
                                        </li>
                                        <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/cheese.html" class="current level_1">
                                                <span>Masking Point Sources (Cheese)</span>
                                            </a>
                                        </li>
                                       <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/fovspecimage.html" class="current level_1">
                                                <span>FOV Spectrum and Image</span>
                                            </a>
                                       </li>
                                       <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/residual_sp.html" class="current level_1">
                                                <span>Checking for residual soft proton flares</span>
                                            </a>
                                       </li>
                                       <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/swcx.html" class="current level_1">
                                                <span>Checking for SWCX </span>
                                            </a>
                                       </li>
                                       <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/EP_vs_EW.html" class="current level_1">
                                                <span>Emission Peak vs. Emission-weighted Centre</span>
                                            </a>
                                       </li>
                                       <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/spectral_fit.html" class="current level_1">
                                                <span>Spectral Fit</span>
                                            </a>
                                        </li>	
					
                                       <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/matheqn.html" class="current level_1">
                                                <span>Including math eqns in GitHub</span>
                                            </a>
                                        </li>
					   <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/about_me.html" class="current level_1">                                                <span>About Me</span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
<!--index page ends-->
                        <div id="cc-tp-nav-btm"></div>
                    </div>
	
                    <div id="cc-tp-sidebar">
                        <div id="cc-tp-sidebar-top"></div>
                        <div class="cc-tp-gutter">
                            <div data-container="sidebar">
                                <div id="cc-matrix-1112072072">
                                    <div id="cc-m-11549662272" class="j-module n j-text ">
                                      <p style="text-align: center;">

                                      <p style="text-align: center;">
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="cc-tp-sidebar-btm"></div>
                    </div>

                </div>

                <div id="cc-tp-content" class="cc-content-parent">
                    <div id="cc-tp-content-top"></div>
                    <div class="cc-tp-gutter cc-content-parent">
                        <div id="content_area" data-container="content">
                            <div id="content_start"></div>

                            <div id="cc-matrix-1112072272">
                                <div id="cc-m-4981642472" class="j-module n j-header ">
                                    <h1 class="" id="cc-m-header-4981642472">Masking Point Sources(Cheese)
</h1>
                                </div>
                                <div id="cc-m-4981638072" class="j-module n j-textWithImage ">
                                    <figure class="cc-imagewrapper cc-m-image-align-1">
                                       
                                     

                                    </figure>
                                    <div>
                                        <div id="cc-m-textwithimage-4981638072" data-name="text" data-action="text" class="cc-m-textwithimage-inline-rte">


<!--
insert begins
<!--
insert begins
-->



<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: right;">
</br>

</br>
 <div style="text-align: right;">
</br>
Last Updated:2023/05/19
</div>
</align right>
</br>

</br>
Source: MCXC J0106.8+0103
</br>
Observation ID: 0762870601  
</br>
SAS Version: 19.0.0
</br>
Python version: 3
</br>
csh is used
</br>

</br>
Everything you need in this tutorial is in:
<a href="https://poonh.github.io/esas_DC/cheese.zip" class="current level_1" target="_blank">
cheese.zip
</a>.
</br>

</br>
You work in the main folder <i>cheese</i>, and put the <i>ccf.cif</i>, SAS files and products from previous chapter like <i>mos1S001-clean.fits</i> in this folder. There are several subfolders:
</br>
1. <i>src</i> - the source code is found there. <i>src/cheese_script.py</i> is what you need in this tutorial.
</br>
2. <i>log</i> - an empty folder for you to put the log files. 
</br>
3. <i>command</i> - the subcommands for the task <i>cheese</i>. Every time you run an ESAS command, there is a temporary file called command.csh which contains all the subcommands. You can run the subcommands one by one. 
</br>
4. <i>esas_products</i> - this is the folder I work on. The content is the same as the main folder but with all the files needed for and created by this chapter. Please note that some files have several updates. Those in the folder are files from the final update.
</br>

</br>
In this tutorial, I only use <i>mos2S002</i> as an example.
</br>

</br>
<b>Masking Point Sources</b>
</br>

</br>
In <i>ESAS</i>, <i>cheese</i> is used to mask point sources. Another common way to do is <i>ewavelet</i>. Now let's set the <i>ccf</i> and run <i>cheese</i>:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>setenv SAS_CCF ccf.cif 
</br>
cheese prefixm="1S001 2S002 " prefixp=S003 scale=0.25 rate=0.0001 dist=0 clobber=1 elow=400 ehigh=2300  > log/cheese.log</i>
</span>
</red>
</br>
  
</br>
and you find the final products you need – <i>mos2S002-bkg_region-det.fits</i>, <i>mos2S002-bkg_region-sky.fits</i> and <i>mos2S002-cheese.fits</i>. However, for SAS 19.0.0, cheese automatically deletes and renames some files upon completion. If you want to understand better what happens. I suggest running the subcommands in <i>command/cheese.csh</i> one by one. In this tutorial, I use the products produced from this script. I will first show the individual commands and then I will show you how to do the whole thing <a href="#fast" rel="noopener">fast</a> using the python script <i>src/cheese_script.py</i>.
</br>

</br>
<b>1.Step by step guide </b>
</br>

</br>
Here are the basic steps in <i>cheese</i>.
</br>
Open the python script and see what you need. 
</br>
Here are the basic steps in cheese.
</br>

</br>
<a href="#step1" rel="noopener">
1.</a>Produce the following for point source detection:
</br>
a) an image extracted from <i>mos2S002-clean.fits</i> in a certain energy range of your choice
</br>
b) an exposure map in the same energy range
</br>
c) create a “mask” image from the exposure map on which the point sources search will perform. This is an image indicating the valid region for the search. CCDs and bad pixels are invalid regions with a value = 0, and all other parts = 1.
</br>


<a href="#step2" rel="noopener">
 2.</a> run <i>eboxdetect</i> for the first time for local detection using the products produced in the previous step to produce a file called <i>eboxlist_l.fits</i>. This file contains detected point sources information.
</br>


<a href="#step3" rel="noopener">
3.</a> Run <i>esplinemap</i> using <i>eboxlist_l.fits</i> to produce a background map called <i>mos2S002-obj-imbkg.fits</i> from non-source regions.
</br>


<a href="#step4" rel="noopener">
4. </a>Run <i>eboxdetect</i> for the second time for map detection using the background map produced from the previous step. A file called <i>eboxlist_m.fits</i> is produced, which has some overlap with <i>eboxlist_l.fits</i>.
</br>


<a href="#step5" rel="noopener">
5.</a> Run <i>emldetect</i> to perform psf fitting on the point sources in <i>eboxlist_m.fits</i>. The final sources satisfying selection criteria is put in emllist.fits.


</br>
<a href="#step6" rel="noopener">
6.</a> Run region twice to create two fits files which contain the size and coordinates of the detected point sources satisfying selection criteria in sky and detector coordinates. The files are called <i>mos2S002-bkg_region-sky.fits</i> and <i>mos2S002-bkg_region-det.fits</i>. <i>mos2S002-bkg_region-det.fits</i> is used to mask point sources when producing a spectrum. <i>mos2S002-bkg_region-sky.fits</i> is used to create a mask in the image form which is used when handling image data in the next step. The point sources detected are different for different ccds. If you want the same mask for all ccds, update <i>mos2S002-bkg_region-sky.fits</i> and <i>mos2S002-bkg_region-det.fits</i> in this step.
</br>

<a href="#step6" rel="noopener">
7.</a> Run make_mask to translate the coordinates and sizes of the point sources in <i>mos2S002-bkg_region-sky.fits</i> to an image. The final product is <i>mos2S002-cheese.fits</i>. This file is used when handling image data.
</br>


<a href="#step8" rel="noopener">
8.</a> Remove or add a mask. The source you feel interested in is probably masked. You have to remove it. Or if you want to enlarge the size of a certain mask or even add an extra mask, do it in this step.
</br>
Here comes the details:
</br>

</br>
 <a id="step1">
   <b>1.Production of an image, exposure map and mask in a certain energy range.</b>
   </a>
</br>

</br>
For the energy range, choose the one you work on. My example is [0.3 – 2.4] keV, the range I use for image data. Of course, we use a far wider range for spectroscopic data, but using the narrow range would result in no difference, I believe.
</br>

</br>
Here are the steps for producing the image, exposure map and mask. All are in <i>src/cheese.csh</i>.
</br>

</br>
Image
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
<i>evselect table=mos2S002-clean.fits:EVENTS withfilteredset=yes expression='(PATTERN<=12)&&(FLAG == 0)&&(PI in [400:2300])' filtertype=expression imagebinning='imageSize' imagedatatype='Int32' imageset=mos2S002-obj-im.fits squarepixels=yes ignorelegallimits=yes withxranges=yes withyranges=yes xcolumn='X' ximagesize=900 ximagemax=48400 ximagemin=3401 ycolumn='Y' yimagesize=900 yimagemax=48400 yimagemin=3401 updateexposure=yes filterexposure=yes verbosity=1</i>
</span>
</red>
</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_img.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="533" width="533" src="https://poonh.github.io/esas_DC/figs/cheese_img.png"></a>
</br>
Fig.1 an image extracted from <i>mos2S002-clean.fits</i> in [0.4 – 2.3] keV. This image shows the photons in this energy range.
</br>

</br>
exposure map
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>eexpmap imageset=mos2S002-obj-im.fits attitudeset=atthk.fits eventset=mos2S002-clean.fits expimageset=mos2S002-obj-imexp.fits withdetcoords=no withvignetting=yes usefastpixelization=no usedlimap=no attrebin=4 pimin=400 pimax=2300 </i>
</span>
</red>
</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_exp.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="533" width="533" src="https://poonh.github.io/esas_DC/figs/cheese_exp.png"></a>
</br>
Fig.2 an exposure map in [0.4 – 2.3] keV. This has been corrected for vignetting effect. Otherwise, all pixels have the same value.  
</br>

</br>
mask
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>emask expimageset=mos2S002-obj-imexp.fits detmaskset=mos2S002-obj-immask.fits detmasktable=MASK threshold1=0.3 threshold2=0.5</i>
</span>
</red>
</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_inmask.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="533" width="533" src="https://poonh.github.io/esas_DC/figs/cheese_inmask.png"></a>
</br>
Fig.3 A mask indicating ccd gaps and bad pixels. All pixels have either a value of 0 or 1. Point source searches only perform on pixels with a value = 1.
</br>

</br>
 <a id="step2">
2. </a>run <i>eboxdetect</i> for the first time for local detection to produce a file called <i>eboxlist_l.fits</i>. This file contains detected point sources information.
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>eboxdetect detmasksets='pnS003-obj-immask.fits mos1S001-obj-immask.fits mos2S002-obj-immask.fits' withdetmask=yes expimagesets='pnS003-obj-imexp.fits mos1S001-obj-imexp.fits mos2S002-obj-imexp.fits' withexpimage=yes nruns=3 
</span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:blue">
likemin=15 
</span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
boxsize=5 ecf='3.2 1.2 1.2' imagesets='pnS003-obj-im.fits mos1S001-obj-im.fits mos2S002-obj-im.fits' boxlistset=eboxlist_l.fits hrdef='1 2 2 3 3 4' pimin='400 400 400' pimax='2300 2300 2300' obsmode=pointing</i>


</br>

</br>
The critical parameter here is <i>likemin</i>, which determines the minimum detection likelihood. Now you can take a look at this file:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>fv eboxlist_l.fits &</i>
</span>
</red>
</br>

</br>
It has 33 columns and 268 rows. For the column <i>ID_INST,0=summary,1=pn,2=mos1,3=mos2</i>. Check other parameters yourself. 
</br>

</br>
 <a id="step3">
3.</a> Run <i>esplinemap</i> using <i>eboxlist_l.fits</i> to produce a background map called <i>mos2S002-obj-imbkg.fits</i> from non-source regions
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>esplinemap 
</span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:blue">
scut=0.01 mlmin=1 
</span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
nsplinenodes=20 excesssigma=4 nfitrun=3 idband=1 boxlistset=eboxlist_l.fits imageset=mos2S002-obj-im.fits expimageset=mos2S002-obj-imexp.fits withexpimage=yes detmaskset=mos2S002-obj-immask.fits withdetmask=yes bkgimageset=mos2S002-obj-imbkg.fits pimin=400 pimax=2300 fitmethod=spline snrmin=30 smoothsigma=15</i>

</red>
</br>

</br>
The important parameters here are <i>scut</i> and <i>mlmin</i>. scut is the source cut level in counts/arcsec**2. <i>mlmin</i> is the minimum detection likelihood. The product of this command is <i>mos2S002-obj-imbkg.fits</i>. 
</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_spline.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="533" width="533" src="https://poonh.github.io/esas_DC/figs/cheese_spline.png"></a>
</br>
Fig.4 <i>mos2S002-obj-imbkg.fits</i>, A background map produced from <i>esplinemap</i>.
</br>

</br>
 <a id="step4">
4.</a> Run <i>eboxdetect</i> for the second time for map detection using the background map produced from the previous step(<i>mos2S002-obj-imbkg.fits</i>). A file called <i>eboxlist_m.fits</i> is produced, which has more sources (336) than <i>eboxlist_l.fits</i>
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>eboxdetect bkgimagesets='pnS003-obj-imbkg.fits mos1S001-obj-imbkg.fits mos2S002-obj-imbkg.fits' usemap=yes usematchedfilter=no detmasksets='pnS003-obj-immask.fits mos1S001-obj-immask.fits mos2S002-obj-immask.fits' withdetmask=yes expimagesets='pnS003-obj-imexp.fits mos1S001-obj-imexp.fits mos2S002-obj-imexp.fits' withexpimage=yes nruns=3 
</span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:blue">
likemin=15
</span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
 boxsize=5 withimagebuffersize=no imagebuffersize=640 ecf='3.2 1.2 1.2' imagesets='pnS003-obj-im.fits mos1S001-obj-im.fits mos2S002-obj-im.fits' boxlistset=eboxlist_m.fits withoffsets=no mergedlistset=mergedlist.fits hrdef='1 2 2 3 3 4' pimin='400 400 400' pimax='2300 2300 2300' obsmode=pointing </i>

</red>
</br>

</br>
Again the important parameter is <i>likemin</i>. Lowering this would result in more sources detected.
</br>

</br>
 <a id="step5">
5.</a> Run <i>emldetect</i> to perform psf fitting on the sources in <i>eboxlist_m.fits</i>. The final sources satisfying selection criteria is put in <i>emllist.fits</i>.
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>emldetect boxlistset=eboxlist_m.fits 
</span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:blue">
mllistset=emllist.fits mlmin=10 
</span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
determineerrors=yes fitposition=yes psfmodel=ellbeta nmaxfit=1 nmulsou=1 
</span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:blue">
ecut=15 scut=15 
</span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">

fitextent=yes extentmodel=beta dmlextmin=6 minextent=1.5 maxextent=20 withthreshold=yes threshold=15 threshcolumn=LIKE withtwostage=yes withimagebuffersize=no imagebuffersize=640 withxidband=no xidfixed=no rateonly=no simulate=no pimin='400 400 400' pimax='2300 2300 2300' hrpndef='1 2 2 3 3 4 4 5' xidpndef='2 3 4' hrm1def='1 2 2 3 3 4 4 5' xidm1def='2 3 4' hrm2def='1 2 2 3 3 4 4 5' xidm2def='2 3 4' ecf='3.2 1.2 1.2' xidecf=1 fitcounts=yes fitnegative=no mergedlistset=mergedlist.fits useevents=no usecalpsf=yes withhotpixelfilter=no withoffsets=no withrawrows=no tmpwrite=0 imagesets='pnS003-obj-im.fits mos1S001-obj-im.fits mos2S002-obj-im.fits' bkgimagesets='pnS003-obj-imbkg.fits mos1S001-obj-imbkg.fits mos2S002-obj-imbkg.fits' detmasksets='pnS003-obj-immask.fits mos1S001-obj-immask.fits mos2S002-obj-immask.fits' withdetmask=yes expimagesets='pnS003-obj-imexp.fits mos1S001-obj-imexp.fits mos2S002-obj-imexp.fits' withexpimage=yes 

</span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:blue">
sourceimagesets='pnS003-obj-imsmap.fits mos1S001-obj-imsmap.fits mos2S002-obj-imsmap.fits' 
</span>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
withsourcemap=yes</i>

</red>
</br>

</br>
The most important parameter is again <i>mlmin</i> (minimum detection likelihood). <i>scut</i> (source selection radius for fitting) and <i>ecut</i> (source cut-out radius) may also have some effect in the result of source detection. 
</br>

</br>
Now all detected sources are in <i>emllist.fits</i>. Let’s open it:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>fv emllist.fits &</i>
</span>
</red>
</br>

</br>
It has got 46 columns, including those in <i>eboxlist_m.fits</i> An important new column here is 
</br>

</br>
<i>DET_ML</i>, which is the detection likelihood. It will be used in the final extraction of the mask. When you add up this value of different ccds under the same <i>ID_CLUSTER</i>, it is roughly the summary column (i.e. <i>ID_INST = 0</i>). 
</br>

</br>
To make it easier to read, let’s output the important columns which will be used in the final mask extraction into a file called <i>emllist.txt</i>:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>fdump emllist.fits+1 emllist.txt "ID_INST ID_BAND ID_CLUSTER FLUX DET_ML DIST_NN" - pagewidth=256 prhead=no clobber=yes </i>
</span>
</red>
</br>

</br>
(<i>src/cheese_script.py: a.fitstotxt()</i> for the above command)
</br>

</br>
Now let’s open the source images which display all the sources detected in <i>emllist.fits</i>. These images are products of <i>emldetect</i>.They are the same for all ccds.
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>ds9 pnS003-obj-imsmap.fits mos1S001-obj-imsmap.fits mos2S002-obj-imsmap.fits - frame lock image -zoom to fit -zscale -frame prev -zscale -frame prev -zscale & </i>
</span>
</red>
</br>

</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_srcimage.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="533" width="533" src="https://poonh.github.io/esas_DC/figs/cheese_srcimage.png"></a>
</br>
Fig.5 <i>pnS003-obj-imsmap.fits,mos1S001-obj-imsmap.fits</i> and <i>mos2S002-obj-imsmap.fits</i>. The images display the sources detected in <i>emllist.fits</i>.
</br>

</br>
Now you can test by running emldetect again, but change <i>mlmin</i> to a larger value, e.g. 150, and open <i>mos2S002-obj-imsmap.fits</i>. You find there are a lot less sources.
</br>

</br>
<a id="step6">
6&7.<a/> Now we have finalized the sources in <i>emllist.fits</i>. We have to make further cuts to have the final list. Run <i>region</i> twice to create two fits files which contain the size and coordinates of the detected point sources satisfying selection criteria in sky and detector coordinates. The files are called <i>mos2S002-bkg_region-sky.fits</i> (for image data, this file needs further processing) and <i>mos2S002-bkg_region-det.fits</i> (for spectroscopic data). 
</br>

</br>
Remember at the beginning you input some parameters when calling cheese? Here are when these parameters come into play!
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>region eventset=mos2S002-clean.fits operationstyle=global srclisttab=emllist.fits:SRCLIST expression='
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
  (FLUX >= 1e-18)

    <span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
    &&
</span>
    <span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:blue">
    (DET_ML >= 15)
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
  &&
 </span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:blue">
  (ID_INST == 3)
 </span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
  &&
 </span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:blue">
  (DIST_NN >= 0)
</span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
  &&(ID_BAND == 1)' bkgregionset=mos2S002-bkg_region-det.fits
 </span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:blue">
    bkgfraction=0.25
</span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
  radiusstyle=contour nosrcellipse=no
 </span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:blue">
    outunit=detxy
</span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
  verbosity=1
  </span>
</br>

</br>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
  region eventset=mos2S002-clean.fits operationstyle=global srclisttab=emllist.fits:SRCLIST expression='(DIST_NN >= 0)&&(DET_ML >= 15)&&(ID_INST == 3)&&(FLUX >= 1e-18)&&(ID_BAND == 1)' bkgregionset=mos2S002-bkg_region-sky.fits radiusstyle=contour nosrcellipse=no bkgfraction=0.25
   </span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:blue">

  outunit=xy
 </span>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">

  verbosity=1</i>
</span>
</red>
</br>

</br>
When you run cheese, you input: scale=0.25 rate=0.0001 dist=0. scale is the bkgfraction, which means the source is removed down to a level where the surface brightness of the source is one quarter of the surrounding background. rate=0.0001 corresponds to <i>FLUX >= 1e-18</i>. rate=1 is 10**14 ergs /cm**2/s. and <i>dist=0</i> is <i>DIST_NN >= 0</i>, which is the minimum separation for sources in arc seconds (The cookbook suggests a default of 50, and can be as large as 1000). outunit is the source coordinate. detxy for detector and xy for sky coordinates.
</br>

</br>
For <i>DET_ML >= 15</i>, it is the detection likelihood limit. <i>ID_INST</i> indicates the instrument, with <i>pn= 1, mos1=2, mos2=3</i>. In this case, different ccds have their own mask since for the same source, they have a different DET_ML. Now let’s check how well the source mask masks sources. To begin with, let’s produce the rate image by dividing the counts image, <i>mos2S002-obj-im.fits</i>, by the exposure, <i>mos2S002-obj-imexp.fits</i>:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>farith mos2S002-obj-im.fits mos2S002-obj-imexp.fits mos2S002-rate.fits DIV</i>
</span>
</red>
</br>

</br>
(<i>bin/cheese_script.py : a.makeImg()</i> for the above)
</br>

</br>
Note that we don’t correct for oot events for pn here.
</br>

</br>
Next we have to convert <i>mos2S002-bkg_region-sky.fits</i> into ds9 readable format. The output is <i>mos2_sky.reg</i>. In <i>src/cheese_script.py</i>, you do it with this line:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:black">
<black>
</br>
<i>a.regionextract("mos2S002-bkg_region-sky.fits",”mos2_sky.reg”)</i>
</span>
</black>
</br>

</br>
and the output is a text file with the coordinates and radii called <i>mos2_sky.reg</i>. If you convert other ccds and also the files for detector coordinates (<i>mos2S002-bkg_region-det.fits</i>), you find for sky coordinates, different ccds have the same coordinates but not the detector ones. The radii are different for different ccds due to psf fitting.
</br>

</br>
Let’s take a look to learn better. 
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>emacs mos1_sky.reg mos2_sky.reg pn_sky.reg
</br>
emacs mos1_det.reg mos2_det.reg pn_det.reg &</i>
</span>
</red>
</br>

</br>
Then we open <i>rate-mos2S002.fits</i> with the point sources of <i>mos2S002-bkg_region-sky.fits</i> loaded. You can also compare with <i>mos2S002-obj-imsmap.fits</i>, which shows the point sources not passing the selection criteria.
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>ds9 mos2S002-rate.fits -scale limits 0 5e-5 -zoom to fit -smooth  -region load mos2_sky.reg mos2S002-obj-imsmap.fits -zoom to fit -zscale &</i>
</span>
</red>
</br>

</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_rate_imsmap.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="280" width="540" src="https://poonh.github.io/esas_DC/figs/cheese_rate_imsmap.png"></a>
</br>
Fig.6 left: <i>rate-mos2S002.fits</i>. right: <i>mos2S002-obj-imsmap.fits</i>, an image showing all sources in <i>emllist.fits</i>.
</br>

</br>
If you think it is not good, then do <i>region</i> again, lowering the threshold of <i>DET_ML</i>. 
</br>

</br>
Let’s check further all the ccds.
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>ds9 rate-mos1S001.fits -scale limits 0 5e-5 -smooth -region load mos1_sky.reg rate-mos2S002.fits -scale limits 0 5e-5 -smooth -region load mos2_sky.reg rate-pnS003.fits -scale limits 0 5e-5 -zoom to fit -smooth -region load pn_sky.reg -frame prev -zoom to fit -frame prev -zoom to fit &</i>
</span>
</red>
</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_all_v1.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="533" width="533" src="https://poonh.github.io/esas_DC/figs/cheese_all_v1.png"></a>
</br>
Fig.7 top left: <i>rate-mos1S001.fits</i>,top right: <i>rate-mos2S002.fits</i>, bottom left: <i>rate-pnS003.fits</i>
</br>

</br>
<i>pn</i> finds a lot more point sources! I believe the reason is pn detects photons a few times higher than <i>mos1</i> and <i>mos2</i>, resulting in a higher detection likelihood. Now let’s load the rate images of <i>mos2</i> but with the pn region file loaded, and compare with the one you just loaded:
</br>

</br>
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
   <i>ds9 rate-mos2S002.fits -scale limits 0 5e-5 -smooth -region load mos2_sky.reg rate-mos2S002.fits -scale limits 0 5e-5 -smooth -region load pn_sky.reg -zoom to fit -frame prev -zoom to fit  &</i>
    </span>
</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_large.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="280" width="560" src="https://poonh.github.io/esas_DC/figs/cheese_large.png"></a>
</br>
Fig.8 Close-up of <i>rate-mos2S002.fits</i>. The left one is loaded with <i>mos2’s</i> mask. The right one is loaded with <i>pn’s</i> mask. Green ellipses are common masks to both, cyan only found in <i>mos2</i> and red only found in <i>pn</i>. 
</br>

</br>
In the above figure, you see in some red ellipses, there is a faint source, but just too dim to pass the selection criteria. The opposite also happens. There are sources found in <i>mos2</i> but not <i>pn</i>. If you want all ccds having the same mask, we have to do region again but choose the summary band, i.e. (<i>ID_INST ==0</i> )&&(<i>ID_BAND == 0</i>). But if you open emllist.fits, you find for <i>ID_BAND=0</i>, there are a lot of <i>FLUX</i> with “INDEF”. 
</br>

</br>
Let’s take a look:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>fdump emllist.fits+1 oldflux.txt "ID_INST FLUX" - pagewidth=256 prhead=no clobber=yes</i>
</span>
</red>
</br>

</br>
If that mask is detected in one ccd (e.g. <i>mos2</i> or <i>pn</i>), but falls on ccd gaps or missing ccds in another(e.g.<i> mos1</i>), the summary band would be “INDEF”. So, in order to use this band, we have to update <i>emllist.fits</i> first so that there is no <i>INDEF </i>value for the summary band. In <i>src/cheese_script.py</i>, you find the following line:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:black">
<black>
</br>
<i>a.emllistUpdate()</i>
</span>
</black>
</br>

</br>
The <i>FLUX</i> of the summary band is roughly the average of the ccds. 
</br>

</br>
Now check <i>emllist.fits</i> again:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>fdump emllist.fits+1 newflux.txt "ID_INST FLUX" - pagewidth=256 prhead=no clobber=yes</i>
</span>
</red>
</br>

</br>
Compare <i>newflux.txt</i> and <i>oldflux.txt</i>, and you see <i>FLUX</i> is successfully updated. 
</br>

</br>
Now we do <i>region</i> again to extract <i>mos2S002-bkg_region-det.fits</i> and <i>mos2S002-bkg_region-sky.fits</i>, this time using the summary band,(<i>ID_INST == 0</i>)&&(<i>ID_BAND == 0</i>):
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>region eventset=mos2S002-clean.fits operationstyle=global srclisttab=emllist.fits:SRCLIST expression='(FLUX >= 1e-18)&&(DET_ML >= 15)&&(ID_INST == 0)&&(DIST_NN >= 0)&&(ID_BAND == 0)' bkgregionset=mos2S002-bkg_region-det.fits  bkgfraction=0.25 radiusstyle=contour nosrcellipse=no outunit=detxy verbosity=1
</br>

</br>
region eventset=mos2S002-clean.fits operationstyle=global srclisttab=emllist.fits:SRCLIST expression='(DIST_NN >= 0)&&(DET_ML >= 15)&&(ID_INST == 0)&&(FLUX >= 1e-18)&&(ID_BAND == 0)' bkgregionset=mos2S002-bkg_region-sky.fits radiusstyle=contour nosrcellipse=no bkgfraction=0.25 outunit=xy verbosity=1</i>
</span>
</red>
</br>

</br>
then make the <i>cheese</i> image again:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>make_mask inimage=mos2S002-obj-im.fits inmask=mos2S002-mask-im.fits outmask=mos2S002-cheese.fits reglist=mos2S002-bkg_region-sky.fits   </i>
</span>
</red>
</br>

</br>
<i>(src/cheese_script.py:a.remakeRegion())</i>
</br>

</br>
Now you open <i>mos1S001-cheese.fits</i>, <i>mos2S002-cheese.fits</i> and <i>pnS003-cheese.fits</i>, they all have the same masks. Sources detected in one ccd are also masked in other ccds.
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>ds9 pnS003-cheese.fits mos1S001-cheese.fits mos2S002-cheese.fits -frame lock image -zoom to fit & </i>
</span>
</red>
</br>

</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_mask1.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="533" width="533" src="https://poonh.github.io/esas_DC/figs/cheese_mask1.png"></a>
</br>
Fig.9 <i>pnS003-cheese.fits</i> <i>mos1S001-cheese.fits</i> and <i>mos2S002-cheese.fits</i>. After update, all ccds have the same masks.
</br>

</br>
<a id="step3">
<b>8. remove or add a mask</b></a>
</br>

</br>
a. How to remove a mask
</br>

</br>
From the above, we see the cluster in the centre is also masked. This is not what we want, we now have to remove it. The easiest way is to open <i>mos2S002-bkg_region-sky.fits</i> and <i>mos2S002-bkg_region-sky.fits</i> with <i>fv</i>, and then manually change the radii to 0.
</br>

</br>
If you don’t want to do it manually, let’s do it with other commands in <i>ftools</i>. First, we need to decide which mask we have to remove, we convert mos2S002-bkg_region-sky.fits to a <i>ds9</i> readable file again and load it: 
</br>

</br>
in <i>src/cheese_script.py</i>:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:black">
<black>
</br>
<i>a.regionextract("mos2S002-bkg_region-sky.fits","mos2_sky_v2.reg")</i>
</span>
</black>
</br>

</br>
then:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>ds9 rate-mos2S002.fits -scale limits 0 5e-5 -smooth -region load mos2_sky_v2.reg &</i>
</span>
</red>
</br>

</br>

<Img link:cheese_cluster.png>
<img border="0" data-original-height="480" data-original-width="640" height="250" width="500" src="https://poonh.github.io/esas_DC/figs/cheese_cluster.png"></a>
</br>
Fig.10 Close-up view of the cluster. There are two masks which have to be removed.
</br>

</br>
Just click on the ellipses and delete them, then save the new region file to newregion.reg. In the top panel of <i>ds9</i>, choose Region --> Save Region. Remember to save in physical coordiantes.
</br>
</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_physical.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="150" width="300" src="https://poonh.github.io/esas_DC/figs/cheese_physical.png"></a>
</br>
Fig.11 Remeber to choose "physical" in ds9. 
</br>

</br>
If you have difficulty clicking on the ellipses, then on the top panel, choose <i>Edit --> Region </i>.
</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_edit_region.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="432" width="540" src="https://poonh.github.io/esas_DC/figs/cheese_edit_region.png"></a>
</br>
Fig.12 ds9-->Edit-->Region
</br>

</br>
Also, when you click on the ellipse, the information is displayed: the number (its position in the file, you may need this number later), the coordinates, the size and the rotation angle.
</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_circle_details.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="533" width="533" src="https://poonh.github.io/esas_DC/figs/cheese_circle_details.png"></a>
</br>
Fig.13 The informatin displayed when you click on a circle. 
</br>

</br>
If you compare the old and new file, <i>mos2_sky_v2.reg</i> and <i>newregion.reg</i>, you should find 2 masks less. Now we update <i>mos2S002-bkg_region-sky.fits</i> and <i>mos2S002-bkg_region-sky.fits</i> with <i>newregion.reg</i>. 
</br>
 
</br>
When you remove the ellipses previously, if you notice the number, it should be 1 and 12 that we are going to remove. Now let’s check the file before update:
</br>
 
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>fdump mos2S002-bkg_region-sky.fits+1 STDOUT "X Y R" 1,12 pagewidth=256 prhead=no clobber=yes</i>
</span>
</red>
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:black">
<black>
</br>
<i>    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  X&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R
</br>
 
</br>
      1 &nbsp;&nbsp;&nbsp;  2.4456088E+04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2.4862070E+04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.6120641E+03
</br>
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   0.0000000E+00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   0.0000000E+00  &nbsp;&nbsp;&nbsp;&nbsp; 1.6065356E+03
</br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00 &nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0000000E+00
</br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0000000E+00
</br>
     12    &nbsp;2.3949498E+04 &nbsp;&nbsp;&nbsp; &nbsp;  2.5638992E+04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   5.6302734E+02
</br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5.6109601E+02
</br>
         &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0000000E+00 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00
</br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00</i>
</span>
</black>
</br>

</br>
The same for <i>mos2S002-bkg_region-det.fits</i>. You see <i>X</i>, <i>Y</i> and <i>R</i> all have four elements, these are for different types of mask (i.e. circle, ellipse, polygon …etc). We are going to set <i>R</i> to 0. We will come back to this file again after update.
</br>
 
</br>
In <i>src/cheese_script</i>, we first compare the two files and see which lines have to be removed:
</br>
 
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:black">
<black>
</br>
<i>remove_index=a.DeleteMask("pn_sky_v2.reg","newregion.reg")</i>
</span>
</black>
</br>

</br>
then we remove the unwanted line:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:black">
<black>
</br>
<i>a.rowchange("mos2S002-bkg_region-sky.fits","R",0,remove_index,[1,2],ccd=mos2)</i>
</span>
</black>
</br>

</br>
This line is equivalent to
</br>
 
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>fpartab 0 mos2S002-bkg_region-sky.fits+1 R row=1 element=1
</br>
fpartab 0 mos2S002-bkg_region-sky.fits+1 R row=1 element=2</i>
</span>
</red>
</br>
 
</br>
With <i>fpartab</i>, you change a certain element of a certain row of a certain quantity to a certain value. Here we change the “R” of element 1and 2 or row 1 to 0. Here the “+1” of <i>mos2S002-bkg_region-sky.fits+1</i> means the first extension, which is <i>REGION</i>. When you do <i>a.rowchange()</i>, <i>mos2S002-bkg_region-det.fits</i> is also updated with coordinate converted using <i>ecoordconv</i>. After the update, we make the cheese image again:
</br>
 
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>make_mask inimage=mos2S002-obj-im.fits inmask= mos2S002-mask-im.fits outmask= mos2S002-cheese.fits reglist=mos2S002-bkg_region-sky.fits</i>
</span>
</red>
</br>
 
</br>
Now let’s check row 1 and 12 of <i>mos2S002-bkg_region-sky.fits</i> again, you see <i>R</i> is set to 0.
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>fdump mos2S002-bkg_region-sky.fits+1 STDOUT "X Y R" 1,12 pagewidth=256 prhead=no clobber=yes</i>
</span>
</red>
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:black">
<black>
</br>
<i>        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  X&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R
</br>
 
</br>
      1 &nbsp;&nbsp  2.4456088E+04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   2.4862070E+04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   0.0000000E+00
</br>
     &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     0.0000000E+00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   0.0000000E+00 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00
</br>
     &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;     0.0000000E+00 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00
</br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;      0.0000000E+00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   0.0000000E+00 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00
</br>
     12 &nbsp; 2.3949498E+04 &nbsp;&nbsp;&nbsp;&nbsp;  2.5638992E+04 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00
</br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;      0.0000000E+00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   0.0000000E+00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   0.0000000E+00
</br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;      0.0000000E+00 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00
</br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;      0.0000000E+00 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  0.0000000E+00</i>
</span>
</black>
</br>

</br>
Again the same for <i>mos2S002-bkg_region-det.fits</i>. If you are not familiar with <i>ecoordconv</i>. I suggest that you try converting the sky coordinates to detector coordinate susing this, and cross check with <i>mos2S002-bkg_region-det.fits</i>.
</br>
 
</br>
Finally, here are the cheese images we want:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>ds9 pnS003-cheese.fits mos1S001-cheese.fits mos2S002-cheese.fits -frame lock image -zoom to fit & </i>
</span>
</red>
</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_final.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="533" width="533" src="https://poonh.github.io/esas_DC/figs/cheese_final.png"></a>
</br>
Fig.14 <i>pnS003-cheese.fits, mos1S001-cheese.fits</i> and <i>mos2S002-cheese.fits</i>. Now all three ccds have the same mask.
</br>

</br>
In the new cheese images, the cluster in the centre is no longer masked.
</br>
And these would be used for analysis hereafter.
</br>

</br>
<b>b. How to add a mask</b>
</br>

</br>
Now we have got two rows in <i>mos2S002-bkg_region-sky.fits</i> empty. If you want to add a mask, just update these two rows with new values using fpartab or <i>a.ChangeMask()</i> in <i>src/cheese_script.py</i>. For extended sources, cheese always cannot produce a mask large enough.
</br>

</br>
In case you are not able to modify the values of any row, you really need to “add” a mask, it is a little bit tricky…I am not sure whether there is a direct way to add a row to <i>mos2S002-bkg_region-sky.fits</i>, no matter you are using ftools or python. To the best I know, you combine <i>mos2S002-bkg_region-sky.fits</i> with a new file being the extra mask. 
</br>
 
</br>
First, we create an empty file called empty.fits using <i>mos2S002-bkg_region-sky.fits</i>, but set all <i>R = 0</i>, or remove unnecessary rows. Then, we input the values of new masks. The original file,<i>mos2S002-bkg_region-sky.fits</i>, has 70 rows, and in this example I need to add two extra masks, so I delete row 1-68 in the following:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>cp mos2S002-bkg_region-sky.fits empty.fits
</br>
cp mos2S002-bkg_region-det.fits emptydet.fits
</br>
fdelrow empty.fits+1 1 68 N Y   </i>
</span>
</red>
</br>
 
</br>
Suppose I have to add the following masks (in sky coordinate):
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>X=17515.893 Y=19017.939  R1=500  R2=500
</br>
X=28728.593. Y=19418.211  R1=1006.1019   R2=553.08489  rotation angle=50</i>
</span>
</red>
</br>
 
</br>
I update the above parameters in <i>empty.fits</i>.
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>fpartab 17515.893 empty.fits+1 X row=1 element=1
</br>
fpartab 19017.939 empty.fits+1 Y row=1 element=1
</br>
fpartab 500 empty.fits+1 R row=1 element=1
</br>
fpartab 500 empty.fits+1 R row=1 element=2
</br>
fpartab 0 empty.fits+1 ROTANG row=1 element=1
</br>

</br>
fpartab 28728.593 empty.fits+1 X row=2 element=1
</br>
fpartab 19418.211 empty.fits+1 Y row=2 element=1
</br>
fpartab 1006.1019 empty.fits+1 R row=2 element=1
</br>
fpartab 553.08489 empty.fits+1 R row=2 element=2
</br>
fpartab 50 empty.fits+1 ROTANG row=2 element=1</i>
</span>
</red>
</br>
 
</br>
Check if the update is successful.
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>fdump empty.fits+1 STDOUT "X Y R" row=1,2 prhead=no showcol=no</i>
</span>
</red>
</br>
 
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:black">
<black>
</br>
 <i>     1 &nbsp;&nbsp  1.7515893E+04&nbsp;&nbsp   1.9017939E+04&nbsp;&nbsp   5.0000000E+02  &nbsp;&nbsp 0.0000000E+00
</br>
   &nbsp;&nbsp    &nbsp;&nbsp   0.0000000E+00 &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  5.0000000E+02 &nbsp;&nbsp  0.0000000E+00
</br>
   &nbsp;&nbsp     &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  0.0000000E+00&nbsp;&nbsp   0.0000000E+00 &nbsp;&nbsp  0.0000000E+00
</br>
   &nbsp;&nbsp     &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  0.0000000E+00
</br>
      2 &nbsp;&nbsp  2.8728594E+04 &nbsp;&nbsp  1.9418211E+04 &nbsp;&nbsp  1.0061019E+03 &nbsp;&nbsp  5.0000000E+01
</br>
     &nbsp;&nbsp   &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  5.5308490E+02 &nbsp;&nbsp  0.0000000E+00
</br>
      &nbsp;&nbsp  &nbsp;&nbsp  0.0000000E+00  &nbsp;&nbsp 0.0000000E+00 &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  0.0000000E+00
</br>
       &nbsp;&nbsp &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  0.0000000E+00  &nbsp;&nbsp 0.0000000E+00
</br>
</i>
</span>
</black>
</br>

</br>
Now merge <i>empty.fits</i> to <i>mos2S002-bkg_region-sky.fits</i>
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>fmerge "mos2S002-bkg_region-sky.fits[1] empty.fits[1]" mos2S002-bkg_region-sky.fits - clobber=yes</i>
</span>
</red>
</br>

</br>
Now you check the last two rows of <i>mos2S002-bkg_region-sky.fits</i> and you see the new masks are added.
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>fdump mos2S002-bkg_region-sky.fits+1 STDOUT "X Y R ROTANG" row=71,72 prhead=no showcol=no</i>
</span>
</red>
</br>

</br>
The terminal shows the new masks:
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:black">
<black>
</br>
<i>     21 &nbsp;&nbsp  1.7515893E+04  &nbsp;&nbsp 1.9017939E+04  &nbsp;&nbsp 5.0000000E+02 &nbsp;&nbsp  0.0000000E+00
</br>
   &nbsp;&nbsp  &nbsp;&nbsp&nbsp;&nbsp     0.0000000E+00  &nbsp;&nbsp 0.0000000E+00  &nbsp;&nbsp 5.0000000E+02&nbsp;&nbsp   0.0000000E+00
</br>
   &nbsp;&nbsp   &nbsp;&nbsp&nbsp;&nbsp    0.0000000E+00 &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  0.0000000E+00&nbsp;&nbsp   0.0000000E+00
</br>
   &nbsp;&nbsp  &nbsp;&nbsp&nbsp;&nbsp     0.0000000E+00 &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  0.0000000E+00&nbsp;&nbsp   0.0000000E+00
</br>
     22 &nbsp;&nbsp  2.8728594E+04 &nbsp;&nbsp  1.9418211E+04 &nbsp;&nbsp  1.0061019E+03&nbsp;&nbsp   5.0000000E+01
</br>
  &nbsp;&nbsp   &nbsp;&nbsp&nbsp;&nbsp     0.0000000E+00&nbsp;&nbsp   0.0000000E+00 &nbsp;&nbsp  5.5308490E+02 &nbsp;&nbsp  0.0000000E+00
</br>
  &nbsp;&nbsp    &nbsp;&nbsp&nbsp;&nbsp    0.0000000E+00 &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  0.0000000E+00
</br>
  &nbsp;&nbsp   &nbsp;&nbsp&nbsp;&nbsp     0.0000000E+00 &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  0.0000000E+00 &nbsp;&nbsp  0.0000000E+00</i>
</span>
</black>
</br>

</br>
 
</br>
Not yet done! Remember to run the following to make <i>mos2S002-cheese-new.fits</i>
</br>
  
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red> 
</br>
<i>make_mask inimage=mos2S002-obj-im.fits inmask=mos2S002-mask-im.fits outmask=mos2S002-cheese-new.fits reglist=mos2S002-bkg_region-sky.fits  </i>
</span>
</red>
</br>

</br>
(<i>src/cheese_script.py: a,emptyFits(),a.NewMask(),a.Mergefits and a.MakeMask()</i> )
</br>

</br>
Now check the old and new cheese image in blink mode. You can easily see the new masks.
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>ds9 mos2S002-cheese-new.fits mos2S002-cheese.fits -lock frame image -blink &</i>
</span>
</red> 
</br>

</br>
Still we have to update <i>mos2S002-bkg_region-det.fits</i>, but when you run <i>src/cheese_script.py</i>, this file is updated.
</br>
 
</br>
<a id="fast">
<b>Fast way to do it</b></a>
</br>

</br>
In <i>src/cheese_script.py</i>, I divide the above process into 5 steps.<i> mos1</i> is taken as <i>mos1S001</i>, <i>mos2</i> as mos2S002,<i> pn</i> as <i>pnS003</i>. If these are not correct, open the script and change the lines defining the ccd prefixes at the beginning.
</br>
 
</br>
1.Step1 opens the rate image <i>rate-mos2S002.fits</i> loaded with the region file <i>mos2S002-bkg_region-sky.fits</i>, and compare with <i>mos2S002-obj-imsmap.fits</i>, an image with all the sources detected in <i>emllist.fits</i>. If you think <i>mos2S002-bkg_region-sky.fits</i> has all the sources you want, proceed to the next step. If not, run <i>emldetect</i> again with different parameter values.
</br>
 
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>python src/cheese_script.py 1</i>
</span>
</red>
</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_step3.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="533" width="533" src="https://poonh.github.io/esas_DC/figs/cheese_step3.png"></a>
</br>
Fig.15 <i>rate-mos2S002.fits</i> and <i>mos2S002-obj-imsmap.fits</i>. <i>mos1</i> and <i>pn</i> are shown together in comparison after running step 1. In this stage, different ccds have different masks. If you are satisfied with the result, go to step 2. If not, run emldetect again with different parameter values.
</br>

</br>
2. Step2 first updates emllist.fits and reproduce all <i>***bkg_region-det.fits</i> and <i>***bkg_region-sky.fits</i> for <i>mos1</i>,<i>mos2</i> and <i>pn</i> so that all ccds have the same masks. Then, <i>ds9</i> opens the rate image loaded with the new masks. Delete all the masks you don’t want and save the new region file as newregion.reg in physical coordinates. <i>mos1</i>, <i>mos2</i> and <i>pn</i> are all shown but you can just use any ccd. Choose the one with not much ccd gaps covering the source you are interested in. You see now all ccds have the same mask.
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>python src/cheese_script.py 2</i>
</span>
</red>
</br>

<a href="https://poonh.github.io/esas_DC/figs/cheese_step2.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="533" width="533" src="https://poonh.github.io/esas_DC/figs/cheese_step2.png"></a>
</br>
Fig.16 <i>rate-mos2S002.fits</i> loaded with updated <i>***bkg_region-sky.fits</i> converted to <i>ds9</i> readable format called <i>mos2_sky_v2.reg</i>. The cluster in the centre is our interest. We have to remove the two masks covering it and save the new file as <i>newregion.reg</i>.
</br>

</br>
3. Step3 returns you the final products you want – updated <i>***bkg_region-det.fits</i> and <i>***bkg_region-sky.fits</i> for <i>mos1,mos2</i> and <i>pn</i>. <i>ds9</i> opens the cheese images and the rate images loaded with updated mask.
</br>

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>python src/cheese_script.py 3</i>
</span>
</red>
</br>
</br>
<a href="https://poonh.github.io/esas_DC/figs/cheese_step1.png" class="current level_1" target="_blank">
<img border="0" data-original-height="480" data-original-width="640" height="275" width="550" src="https://poonh.github.io/esas_DC/figs/cheese_step1.png"></a>
</br>
Fig.17 <i>rate-mos2S002.fits</i> loaded with the updated mask..If you don’t want further changes. This is the final product. 
</br>
 
</br>
Step4: If you need to enlarge a mask and if there is an empty row in <i>***bkg_region-sky.fits</i>. Open <i>src/cheese_script.py</i>,go to step 4 and enter the values of the new mask you want. <i>***bkg_region-det.fits</i> is also updated in this step.
</br>
 
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>python src/cheese_script.py 4</i>
</span>
</red>
</br>
 
</br>
Step5: If you really need to “add” a mask but not modifying any row, do this step. Open <i>src/cheese_script.py</i>, go to step5 and enter the new mask information. 
</br>
 
<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
<red>
</br>
<i>python src/cheese_script.py 5</i>
</span>
</red>
</br>
 
</br>
 
</br>
<b>Reference Websites:</b>
</br>
eboxdetect: 
<a href="http://xmm-tools.cosmos.esa.int/external/sas/current/doc/eboxdetect/" class="current level_1" target="_blank">
</br>
http://xmm-tools.cosmos.esa.int/external/sas/current/doc/eboxdetect/
</a>
</br>
esplinemap: 
<a href="http://xmm-tools.cosmos.esa.int/external/sas/current/doc/esplinemap/" class="current level_1" target="_blank">
</br>
http://xmm-tools.cosmos.esa.int/external/sas/current/doc/esplinemap/
</a>
</br>
emldetect: 
<a href="http://xmm-tools.cosmos.esa.int/external/sas/current/doc/emldetect/" class="current level_1" target="_blank">
</br>
http://xmm-tools.cosmos.esa.int/external/sas/current/doc/emldetect/
</a>
</br>
ftools:
<a href="https://heasarc.gsfc.nasa.gov/lheasoft/ftools/futils.html" class="current level_1" target="_blank">
</br>
https://heasarc.gsfc.nasa.gov/lheasoft/ftools/futils.html
</a>
</span>
<!--
insert ends
-->

					    
</style></span></p><p class="MsoNormal" style="line-height: 16.866667px;"><span lang="EN-GB" style="font-size: 12pt; line-height: 18.4px;">&nbsp;</span></p>
      
                              

   
 


</body>
</html>

 

 

  

    
 

 
</head>


</html>
