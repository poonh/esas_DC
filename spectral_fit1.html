<!DOCTYPE html>
<head>
    <meta charset="utf-8"/>
    <link rel="dns-prefetch preconnect" href="https://u.jimcdn.com/" crossorigin="anonymous"/>
    <link rel="dns-prefetch preconnect" href="https://assets.jimstatic.com/" crossorigin="anonymous"/>
    <link rel="dns-prefetch preconnect" href="https://image.jimcdn.com" crossorigin="anonymous"/>
    <link rel="dns-prefetch preconnect" href="https://fonts.jimstatic.com" crossorigin="anonymous"/>
    <link rel="dns-prefetch preconnect" href="https://www.google-analytics.com" crossorigin="anonymous"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="description" content=""/>
    <meta name="robots" content="index, follow, archive"/>
    <meta property="st:section" content=""/>
 
    <title>ESAS Deconstruction</title>
 


    <style>
    html, body {
        margin:0
    }

    .hidden {
        display:none
    }

    .n {
        padding:5px
    }

    #emotion-header {
        position:relative
    }

    #emotion-header-logo, #emotion-header-title {
        position: absolute
    }
    </style>

    <link href="https://u.jimcdn.com/cms/o/s1c71c378b473a4b7/layout/l18102fdb581481be/css/main.css?t=1678435519" rel="stylesheet" type="text/css" id="jimdo_main_css"/>
    <link href="https://u.jimcdn.com/cms/o/s1c71c378b473a4b7/layout/l18102fdb581481be/css/layout.css?t=1481798901" rel="stylesheet" type="text/css" id="jimdo_layout_css"/>
    <link href="https://u.jimcdn.com/cms/o/s1c71c378b473a4b7/layout/l18102fdb581481be/css/font.css?t=1678435519" rel="stylesheet" type="text/css" id="jimdo_font_css"/>
    <script>

      
    /* <![CDATA[ */
    /*!  loadCss [c]2014 @scottjehl, Filament Group, Inc.  Licensed MIT */
    window.loadCSS = window.loadCss = function(e, n, t) {
        var r,
            l = window.document,
            a = l.createElement("link");
        if (n)
            r = n;
        else {
            var i = (l.body || l.getElementsByTagName("head")[0]).childNodes;
            r = i[i.length - 1]
        }
        var o = l.styleSheets;
        a.rel = "stylesheet",
        a.href = e,
        a.media = "only x",
        r.parentNode.insertBefore(a, n ? r : r.nextSibling);
        var d = function(e) {
            for (var n = a.href, t = o.length; t--;)
                if (o[t].href === n)
                    return e.call(a);
            setTimeout(function() {
                d(e)
            })
        };
        return a.onloadcssdefined = d, d(function() {
            a.media = t || "all"
        }), a
    };
    window.onloadCSS = function(n, o) {
        n.onload = function() {
            n.onload = null,
            o && o.call(n)
        },
        "isApplicationInstalled" in navigator && "onloadcssdefined" in n && n.onloadcssdefined(o)
    } /* ]]> */
    </script>
    <script>
    // <![CDATA[
    onloadCSS(loadCss('https://assets.jimstatic.com/web_oldtemplate.css.484168258c63bd4f69a74e0370dc7ab9.css'), function() {
        this.id = 'jimdo_web_css';
    });
    // ]]>
    </script>
    <link href="https://assets.jimstatic.com/web_oldtemplate.css.484168258c63bd4f69a74e0370dc7ab9.css" rel="preload" as="style"/>
    <noscript>
        <link href="https://assets.jimstatic.com/web_oldtemplate.css.484168258c63bd4f69a74e0370dc7ab9.css" rel="stylesheet"/>
    </noscript>
    <script>
    //<![CDATA[
    var jimdoData = {
        "isTestserver": false,
        "isLcJimdoCom": false,
        "isJimdoHelpCenter": false,
        "isProtectedPage": false,
        "cstok": "",
        "cacheJsKey": "dc04b44e71947b5963ce6fc1404a2bb2ea23e742",
        "cacheCssKey": "dc04b44e71947b5963ce6fc1404a2bb2ea23e742",
        "cdnUrl": "https:\/\/assets.jimstatic.com\/",
        "minUrl": "https:\/\/assets.jimstatic.com\/app\/cdn\/min\/file\/",
        "authUrl": "https:\/\/a.jimdo.com\/",
        "webPath": "https:\/\/www.npokokoro.jp\/",
        "appUrl": "https:\/\/a.jimdo.com\/",
        "cmsLanguage": "ja_JP",
        "isFreePackage": false,
        "mobile": false,
        "isDevkitTemplateUsed": false,
        "isTemplateResponsive": false,
        "websiteId": "s1c71c378b473a4b7",
        "pageId": 912164772,
        "packageId": 2,
        "shop": {
            "deliveryTimeTexts": {
                "1": "\u304a\u5c4a\u3051\u65e5\u6570\uff1a1~3\u65e5",
                "2": "\u304a\u5c4a\u3051\u65e5\u6570\uff1a3~5\u65e5",
                "3": "\u304a\u5c4a\u3051\u65e5\u6570\uff1a5~8\u65e5"
            },
            "checkoutButtonText": "\u8cfc\u5165",
            "isReady": false,
            "currencyFormat": {
                "pattern": "\u00a4#,##0",
                "convertedPattern": "$#,##0",
                "symbols": {
                    "GROUPING_SEPARATOR": ",",
                    "DECIMAL_SEPARATOR": ".",
                    "CURRENCY_SYMBOL": "\uffe5"
                }
            },
            "currencyLocale": "ja_JP"
        },
        "tr": {
            "gmap": {
                "searchNotFound": "\u5165\u529b\u3055\u308c\u305f\u4f4f\u6240\u306f\u5b58\u5728\u3057\u306a\u3044\u304b\u3001\u898b\u3064\u3051\u308b\u3053\u3068\u304c\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002",
                "routeNotFound": "\u30eb\u30fc\u30c8\u304c\u8a08\u7b97\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u76ee\u7684\u5730\u304c\u9060\u3059\u304e\u308b\u304b\u660e\u78ba\u3067\u306f\u306a\u3044\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002"
            },
            "shop": {
                "checkoutSubmit": {
                    "next": "\u6b21\u3078",
                    "wait": "\u304a\u5f85\u3061\u304f\u3060\u3055\u3044"
                },
                "paypalError": "\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u518d\u5ea6\u304a\u8a66\u3057\u304f\u3060\u3055\u3044\u3002",
                "cartBar": "\u30b7\u30e7\u30c3\u30d4\u30f3\u30b0\u30ab\u30fc\u30c8\u3092\u78ba\u8a8d",
                "maintenance": "\u7533\u3057\u8a33\u3054\u3056\u3044\u307e\u305b\u3093\u3001\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u4e2d\u306e\u305f\u3081\u4e00\u6642\u7684\u306b\u30b7\u30e7\u30c3\u30d7\u304c\u5229\u7528\u3067\u304d\u307e\u305b\u3093\u3002\u3054\u8ff7\u60d1\u3092\u304a\u304b\u3051\u3057\u7533\u3057\u8a33\u3054\u3056\u3044\u307e\u305b\u3093\u304c\u3001\u304a\u6642\u9593\u3092\u3042\u3051\u3066\u518d\u5ea6\u304a\u8a66\u3057\u304f\u3060\u3055\u3044\u3002",
                "addToCartOverlay": {
                    "productInsertedText": "\u30ab\u30fc\u30c8\u306b\u5546\u54c1\u304c\u8ffd\u52a0\u3055\u308c\u307e\u3057\u305f",
                    "continueShoppingText": "\u8cb7\u3044\u7269\u3092\u7d9a\u3051\u308b",
                    "reloadPageText": "\u66f4\u65b0"
                },
                "notReadyText": "\u3053\u3061\u3089\u306e\u30b7\u30e7\u30c3\u30d7\u306f\u73fe\u5728\u6e96\u5099\u4e2d\u306e\u305f\u3081\u3054\u5229\u7528\u3044\u305f\u3060\u3051\u307e\u305b\u3093\u3002\u30b7\u30e7\u30c3\u30d7\u30aa\u30fc\u30ca\u30fc\u306f\u4ee5\u4e0b\u3092\u3054\u78ba\u8a8d\u304f\u3060\u3055\u3044\u3002https:\/\/help.jimdo.com\/hc\/ja\/articles\/115005521583",
                "numLeftText": "\u73fe\u5728\u3053\u306e\u5546\u54c1\u306f {:num} \u307e\u3067\u8cfc\u5165\u3067\u304d\u307e\u3059\u3002",
                "oneLeftText": "\u3053\u306e\u5546\u54c1\u306e\u5728\u5eab\u306f\u6b8b\u308a1\u70b9\u3067\u3059"
            },
            "common": {
                "timeout": "\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3044\u305f\u3057\u307e\u3057\u305f\u3002\u5f8c\u307b\u3069\u518d\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044\u3002"
            },
            "form": {
                "badRequest": "\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u5f8c\u307b\u3069\u6539\u3081\u3066\u304a\u8a66\u3057\u304f\u3060\u3055\u3044\u3002"
            }
        },
        "jQuery": "jimdoGen002",
        "isJimdoMobileApp": false,
        "bgConfig": null,
        "bgFullscreen": null,
        "responsiveBreakpointLandscape": 767,
        "responsiveBreakpointPortrait": 480,
        "copyableHeadlineLinks": false,
        "tocGeneration": false,
        "googlemapsConsoleKey": false,
        "loggingForAnalytics": false,
        "loggingForPredefinedPages": false,
        "isFacebookPixelIdEnabled": false,
        "userAccountId": "0c3325d1-6b0b-446f-bc3b-e47d8fbb0d02",
        "dmp": {
            "typesquareFontApiKey": "4L6CCYWjET8%3D",
            "typesquareFontApiScriptUrl": "\/\/code.typesquare.com\/static\/4L6CCYWjET8%253D\/ts105.js",
            "typesquareFontsAvailable": true
        }
    };
    // ]]>
    </script>

    <script type="text/javascript">
    window.CKIES_OPTIN = true;
    </script>
    <script type="text/javascript">
    if (document.cookie.indexOf('ga-disable-UA-24230777-25') != -1 || !window.CookieControl.isCookieAllowed('ga') || !window.CookieControl.isCookieAllowed('jimdo_analytics')) {
        window['ga-disable-UA-24230777-25'] = true;
    }
    </script>
    <script>
    (function(window) {
        'use strict';
        var regBuff = window.__regModuleBuffer = [];
        var regModuleBuffer = function() {
            var args = [].slice.call(arguments);
            regBuff.push(args);
        };
        if (!window.regModule) {
            window.regModule = regModuleBuffer;
        }
    })(window);
    </script>
    <script src="https://assets.jimstatic.com/web.js.12719f3724127512fa9f.js" async="true"></script>

</head>
<body class="body cc-page cc-page-index cc-indexpage cc-pagemode-default cc-content-parent" id="page-912164772">

    <div id="cc-inner" class="cc-content-parent">
        <div id="cc-tp-padding-container" class="cc-content-parent">
            <div id="cc-tp-container" class="cc-content-parent">

                <div id="cc-tp-header">

                </div>

                <div id="cc-tp-wrapper">

                    <div id="cc-tp-navigation">
                        <div id="cc-tp-nav-top"></div>
                        <div class="cc-tp-gutter">
                            <div data-container="navigation">
                                <div class="j-nav-variant-standard">
                                    <ul id="mainNav1" class="mainNav1">
                                        <li id="cc-nav-view-912164772">
                                          <a href="https://poonh.github.io/esas_DC/" class="current level_1">
<!--index page begins-->
                                                <span>HOME</span>
                                            </a>
                                        </li>
                                        <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/filter_SP.html" class="current level_1"> <!-- target="_blank"-->
                                                <span>Filtering for Soft Protons</span>
                                            </a>
                                        </li>
                                        <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/anol_ccd.html" class="current level_1">
                                                <span>Anomalous CCD Check</span>
                                            </a>
                                        </li>
                                        <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/cheese.html" class="current level_1">
                                                <span>Masking Point Sources (Cheese)</span>
                                            </a>
                                        </li>
                                       <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/fovspecimage.html" class="current level_1">
                                                <span>FOV Spectrum and Image</span>
                                            </a>
                                       </li>
                                       <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/residual_sp.html" class="current level_1">
                                                <span>Checking for residual soft proton flares</span>
                                            </a>
                                       </li>
                                       <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/swcx.html" class="current level_1">
                                                <span>Checking for SWCX </span>
                                            </a>
                                       </li>
                                       <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/EP_vs_EW.html" class="current level_1">
                                                <span>Emission Peak vs. Emission-weighted Centre</span>
                                            </a>
                                       </li>
                                       <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/spectral_fit1.html" class="current level_1">
                                                <span>Spectral Fit1</span>
                                            </a>
                                       </li>
                                       <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/spectral_fit2.html" class="current level_1">
                                                <span>Spectral Fit2</span>
                                            </a>
                                        </li>	
                                       <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/luminosity_cal.html" class="current level_1">
                                                <span>Luminosity Calculation</span>
                                            </a>
                                        </li>	
				   
                                       <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/matheqn.html" class="current level_1">
                                                <span>Including math eqns in GitHub</span>
                                            </a>
                                        </li>
					   <li id="cc-nav-view-912164772">
                                            <a href="https://poonh.github.io/esas_DC/about_me.html" class="current level_1">                                                                        <span>About Me</span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
<!--index page ends-->
                        <div id="cc-tp-nav-btm"></div>
                    </div>
	
                    <div id="cc-tp-sidebar">
                        <div id="cc-tp-sidebar-top"></div>
                        <div class="cc-tp-gutter">
                            <div data-container="sidebar">
                                <div id="cc-matrix-1112072072">
                                    <div id="cc-m-11549662272" class="j-module n j-text ">
                                      <p style="text-align: center;">

                                      <p style="text-align: center;">
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="cc-tp-sidebar-btm"></div>
                    </div>

                </div>

                <div id="cc-tp-content" class="cc-content-parent">
                    <div id="cc-tp-content-top"></div>
                    <div class="cc-tp-gutter cc-content-parent">
                        <div id="content_area" data-container="content">
                            <div id="content_start"></div>

                            <div id="cc-matrix-1112072272">
                                <div id="cc-m-4981642472" class="j-module n j-header ">
                                    <h1 class="" id="cc-m-header-4981642472">Spectral Fit1
</h1>
                                </div>
                                <div id="cc-m-4981638072" class="j-module n j-textWithImage ">
                                    <figure class="cc-imagewrapper cc-m-image-align-1">
                                       
                                     

                                    </figure>
                                    <div>
                                        <div id="cc-m-textwithimage-4981638072" data-name="text" data-action="text" class="cc-m-textwithimage-inline-rte">


<!--
insert begins
  -->

<span style="font-family: arial; sans-serif; font-size: 12pt; text-align: right;">
</br>
In order to perform spectral fit for spectra extracted from different annuli, we first have to create the spectra. In this chapter, we are going to learn how to do it, and the fitting will be performed in the next one.</br></br>

To create annuli of suitable size for spectral fit, we need to define "suitable". Some people use number of counts, some use signal to noise(S/N) ratio. I suggest some readings first:</br></br>

If you don't want to use cross arf, make sure the size of each annulus is > 30 arcsecs to limit flux redistribution to < 20% (<a href="https://ui.adsabs.harvard.edu/abs/2007A%26A...467..437Z/abstract" class="current level_1" target="_blank">Zhang 2007</a> Scaling relations and mass calibration of the X-ray luminous galaxy clusters at redshift ~0.2: XMM-Newton observations, Sec 2.3). In the same paper, the authors require a net counts of ~ 2000 in 2-7 keV for each spectrum.</br></br>

 <a href="https://ui.adsabs.harvard.edu/abs/2020ApJ...892..102L/abstract" class="current level_1" target="_blank">Lovisari et al 2020 </a>(X-Ray Scaling Relations for a Representative Sample of Planck-selected Clusters Observed with XMM-Newton) defined annulus size by S/N ratio and some other criteria. One purpose of deriving the spectrum of different annulus is to derive the temperature profile (for the derivation of hydrostatic mass). How many bins are enough? A good reference is Table 3 of this paper, column 11 N<sub>T</sub>. You see the number of bins can be as small as 1, and more than 30.</br></br>

To derive the hydrostatic mass, you can use the backward method (based on a model like NFW profile) or forward method (no model assumed, I used this method for my work). In another paper by <a href="https://ui.adsabs.harvard.edu/abs/2020A%26A...644A..78L/abstract" class="current level_1" target="_blank">Lovisari et al 2020 (Comparing different mass estimators for a large subsample of the Planck-ESZ clusters)<a/>, the less extrapolation of the temperature profile (i.e. last bin being closed to r<sub>500</sub>, the better the agreement between the hydrostatic mass derived using forward and backward method. Again in Table 3 of the above mentioned paper, column 12 f<sub>T</sub>, you can check the fraction of r<sub>500</sub> covered by the temperature profile. Also in the code I provide in this chapter, I provide the fraction of the mid point of the outermost annulus to the limiting radius you provide. </br></br>

There are many others papers suitable. I will update this list later.</br></br>
  

Here are what I use for this tutorial: </br></br>

Source: MCXC J0106.8+0103 </br>
Observation ID: 0762870601 </br>
SAS Version: 19.0.0 </br>
Python version: 2 (3 maybe ok, I don't have enought time to check) </br>
csh is used </br></br>

Everything you need in this tutorial is in:  <a href="https://poonh.github.io/esas_DC/spectral_fit1.zip" class="current level_1" target="_blank">spectral_fit1.zip</a> . </br></br>

You work in the main folder swcx, there are several subfolders: </br>
1. src - the source code is found here. </br>
2. InputFiles - the folder in which the good ccd lists for mos1(goodccdlist_mos1.dat) and mos2(goodccdlist_mos2.dat) are put. This is created in Anomalous CCD Check. </br>
3. products - the files created in this tutorial. They are put in the main folder if you create them successfully. There are a lot of folders created in this chapter. I am just enclosing <i>mos2S002-0-30</i> as an example.</br>
4. command and log - these are empty folders to be written. You find the same folders in <i>products</i> with files inside.</br></br>


If you have already finished the last chapter and keep everything well. Then, you just need to copy the scripts in src to your current src folder. </br></br>

Here are what you need in the main folder spectral_fit1. You should have them already if you follow the steps in the previous chapters. I already put them in the zip file. </br></br>

1. <i>Centre.txt</i>. We produced this file previously. It contains central position of the cluster in different coordinate systems.</br>
2. the clean event list: mos1S001-clean.fits, mos2S002-clean.fits and pnS003-clean.fits. You need them for everything. </br></br>






If you want to define the size of an annulus by the number of counts,N. Then
</br></br>

<i>
  N = number_of_spectral_counts - number_of_background_counts
</i>

</br></br>
For S/N ratio (noise taken as error of Poisson statistics):
</br></br>
S/N = (number_of_spectral_counts - number_of_background_counts)/sqrt(number_of_spectral_counts)

</br></br>
Note: The spectrum includes both the FOV and background counts.
</br></br>

So in order the estimate the counts (or S/N) in a certain annulus, we need both the FOV and background spectra. The FOV spectrum takes seconds to produce but the background spectrum takes hours(you need to produce the corner spectra, images of each ccd chip...etc). To make things easier, I use the FOV and background images in the same energy range as the spectrum. For spectral anaylsis, I use 0.7 - 10keV, so now I extract images in the same range. Remember for the FOV spectrum and image, they are from the same source(i.e.<i>mos2S002-clean.fits</i>), so both the spectrum and image return you the same number of photons. But for the particle background spectrum and the particle background image, they are from different sources. However, in Table 2 of <a href="https://poonh.github.io/esas_DC/fovspecimage.html" class="current level_1" target="_blank"> FOV Spectrum of Image</a>, for the background spectrum and image in 0.7-10 keV, the <i>mos</i> ccds roughly have the same number of counts (<i>pn</i> is different but <i>pn</i> gives you enough counts anyway), so I think it is good to use the image data as an estimate. </br></br>


Now we produce the images in the 0.7 - 10 keV using the script <i>src/spectral_fit_script.py</i>:</br></br>

<i>
  <span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
    python3 src/spectral_fit_script.py 1
  </span>
  </i>
</br></br>

"1" is step 1, which produces the following files in the folder <i>full_spectrum_mos2</i> (<i>mos2</i> is used as an example):</br></br>

<i>
mos2S002-obj-im-700-10000.fits (image of the FOV in sky coordinate)</br>
mos2S002-obj-im-det-700-10000.fits (image of the FOV in detector coordinate)</br>
mos2S002-im1-700-10000.fits (images of the ccd chip of the fwc files, only for good ccd chips)</br>
mos2S002-im2-700-10000.fits</br>
mos2S002-im3-700-10000.fits</br>
mos2S002-im4-700-10000.fits</br>
mos2S002-im5-700-10000.fits</br>
mos2S002-im6-700-10000.fits</br>
mos2S002-im7-700-10000.fits</br>
mos2S002-exp-im-700-10000.fits (exposure image)</br>
mos2S002-mask-im-700-10000.fits (an image indicating bad pixels and ccd gaps)</br>
mos2S002-back-im-det-700-10000.fits (background image in detector coordinate)</br>
mos2S002-back-im-sky-700-10000.fits (background image in sky coordinate)</br>
comb-obj-im-700-10000.fits (mos2S002-obj-im-700-10000.fits*cheese)</br>
comb-back-im-sky-700-10000.fits (mos2S002-back-im-sky-700-10000.fits*cheese)</br>
comb-exp-im-700-10000.fits (mos2S002-exp-im-700-10000.fits*cheese corrected by scaling factor)</br>

</br>
</i>

For <i>pn</i>, you also need the relevent <i>oot</i> images. Don't worry. The script has got it already.</br></br>

We already produced the images in the soft band - 0.4 - 2.3 keV in <a href="https://poonh.github.io/esas_DC/fovspecimage.html" class="current level_1" target="_blank"> FOV Spectrum and Image</a>, and we wrote the commands in <i>command/FOV_imgspe_mos2.csh</i> . Now we are just doing the same thing. We first extract the relevant commands in <i>command/FOV_imgspe_mos2.csh</i> and rewrite them in <i>full_spectrum_mos2/backgd_command_mos2.csh</i> by replacing the old energy range with the new one. In the python script, <i>full_spectrum_mos2/backgd_command_mos2.csh</i> is run automatically and files are created in the same folder. In case of problems, run the commands in the csh script one by one to check where the problems are.</br></br>


2. Now we have produced the files in the energy range we want, it would be good to take a look at the surface brightness profile and check the size of the cluster. You can also take the r<sub>500</sub> value in the MCXC catalogue as reference. The surface brightness profile also tells where you can choose the cosmic X-ray background. For me, I choose a region certain distance away from r<sub>500</sub>(say, 0.5 to 1 arcmin away). I will have more details in the next chapter <a href="https://poonh.github.io/esas_DC/spectral_fit2.html" class="current level_1" target="_blank">Spectral Fit II </a>.</br></br>

The problem comes here. We work in the range 0.7 - 10 keV, so we are supposed to check the profile in this range, right? </br></br>

<i>
  <span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
    python3 src/spectral_fit_script.py 2a
  </span>
</i>
</br></br>
("2a" plots the the surface brightness profile using the combined image, background and exposure map (i.e. <i>comb-obj-im-700-10000-mos2.fits</i>, <i>comb-back-im-sky-700-10000-mos2.fits</i> and <i>comb-exp-im-700-10000-mos2.fits</i>) in the folder <i>full_spectrum_mos2</i> in 0.7 - 10 keV (surface brightness = (image - background)/exposure). In case you forget the meaning of "combined", check Fig. 10 of <a href="https://poonh.github.io/esas_DC/fovspecimage.html" class="current level_1" target="_blank">FOV spectrum and image</a>)
</br></br>

<a href="https://poonh.github.io/esas_DC/figs/spectral_fit1_sb_0.7-10eV.png" class="current level_1" target="_blank">
<img border="0" data-original-height="400" data-original-width="700" height="500" width="600" src="https://poonh.github.io/esas_DC/figs/spectral_fit1_sb_0.7-10eV.png"></a>
</br>
Fig.1 Surface brightness profile of <i>pnS003</i>, <i>mos1S001</i> and <i>mos2S002</i> using combined images, background and exposure in 0.7 - 10.0 keV.
</br></br>



This cluster has a r<sub>500</sub> of ~ 4.6 arcmins. The rising trend towards the end is due to the vignetting effect. Remeber the Sx = counts/exposure. Towards outer radius we have less and less counts, and the exposure gets smaller and smaller due to vignetting effect.  The effect of smaller exposure outweighs the effect of less counts, resulting in a rising profile (I believe if you have a long enough exposure time, you will have sufficient counts to have a flat profile). You see this trend in most clusters.</br></br>
I got off topic... the problem here is obviously <i>pn</i> has a higher cosmic X-ray background. So what about 0.4 - 2.3 keV?</br></br>


<i>
  <span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
    python3 src/spectral_fit_script.py 2
  </span>
</i>
</br></br>
("2" produces the same plot but in 0.4 - 2.3 keV)</br></br>


<a href="https://poonh.github.io/esas_DC/figs/spectral_fit1_sb_0.4-2.3eV.png" class="current level_1" target="_blank">
<img border="0" data-original-height="400" data-original-width="700" height="500" width="600" src="https://poonh.github.io/esas_DC/figs/spectral_fit1_sb_0.4-2.3eV.png"></a>
</br>
Fig.2 Surface brightness profile of <i>pnS003</i>, <i>mos1S001</i> and <i>mos2S002</i> using combined images, background and exposure in 0.4 - 2.3 keV. 
</br></br>


So you see here, for 0.4 - 2.3 keV, you have a <i>pn</i> profile which agress with <i>mos</i>, but not 0.7 - 10 keV. What does it mean? It is probably due to the particle background image. Let me remind you:

Sx = (counts - particle background)/exposure

which is

[(comb-obj-im-400-2300.fits) - (comb-back-im-sky-400-2300.fits)]/(comb-exp-im-700-400-2300.fits)

The difference in outer radius in the 0.7 - 10 keV plot is likely due to the particle background. Since this energy range shows noticeble difference I really wonder whether the particle background in this energy range correctly reflects the particle background ...Luckily for luminosity calculation, we only use the soft band. However, there is another problem, if the image correctly reflects the CXB background in all ccds, which mainly lies in low energy, what about the spectrum? In Table 2 of

<a href="https://poonh.github.io/esas_DC/fovspecimage.html" class="current level_1" target="_blank">
  FOV spectrum and image</a>, I already showed that in the soft band, for the <i>mos</i> CCDs, the spectrum only have half of the background counts of the image (both are produced by <i>mos_back</i>) while <i>pn</i> has roughly the same number. If the background image in the soft band gives an accurante description of the background, then the spectrum wouldn't ...ok... I will check in the next chapter. What is affected here is the CXB value, an overestimation of which leads to underestimation of the APEC normalization of the cluster. If you use spectral data to do the luminosity, it is certainly affected. </br></br>

By the way, 1) this is true for all sources, except for those with noticeable soft proton contamination. At this stage, the image still contains soft proton, which will be removed after spectra fit. I will come back to check the surface brightness profile in 0.7 - 10 keV again to see whether soft proton is successfully removed (OK! I found another way of checking for soft protons. This means. If soft proton outweighs particle background, <i>pn</i> and <i>mos</i> surface brightness profiles still overlap at the outskirt). 2) The problem comes from 7 - 10 keV, the high energy end (I checked the images in different energy bands but I am not showing the results here). 

</br></br>

I need to go back to track ... from the above two plots (fig 1 and 2), the fortunate thing is the profiles for all ccds for any energy range becomes flat at more or less the same point, roughly 4 - 5 arcmins. Then we can decide where to choose the CXB. Here I use 4.6 arcmin (taken from the MCXC catalogue) as the cutoff radius for the cluster and 5.6 - 15 arcmin as the CXB background. 

</br></br>



3. Now we have set our criteria, we can run the script (You will be asked at the prompt to input the limiting radius. Enter in arcsec. The value for this sample is 276.):
</br></br>

<i>
  <span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
    python3 src/spectral_fit_script.py 3
  </span>
</i>
</br></br>

The criteria for the size of annulus is 1) > 1500 counts (I use <i>mos2</i> as reference here) 2) The inner and outer radii should be at least 30 arcsecs apart<a href="https://ui.adsabs.harvard.edu/abs/2008A&A...482..451Z" class="current level_1" target="_blank">(Zhang et al 2008)</a>. You can change the criteria by modifying the code. 

</br></br>
The script returns you the following:</br></br>

<i>
  <span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:black">
    
source region(arcsec) counts(bkg subtracted)</br>
                   mos1        mos2      pn</br>
0.00 - 30.00:  || 6134.66 || 6659.19 || 14701.18</br>
30.00 - 60.00:  || 2785.77 || 2667.03 || 6127.48</br>
60.00 - 110.00:  || 1720.39 || 1665.47 || 3546.17</br>
110.00 - 276.00:  || 1640.75 || 1540.89 || 4329.92</br>
S/N ratio</br>
0.00 - 30.00:  || 81.44 || 78.18 || 120.99</br>
30.00 - 60.00:  || 50.97 || 52.06 || 77.43</br>
60.00 - 110.00:  || 38.23 || 38.90 || 57.03</br>
110.00 - 276.00:  || 26.68 || 28.22 || 54.07</br>
cxb region(arcsec) counts(bkg subtracted)</br>
                   mos1        mos2      pn</br>
336.00 - 596.00: 1368.19 || 1504.17 || 9870.67</br>
596.00 - 900.00: 1463.09 || 1537.47 || 13368.24</br>
S/N ratio</br>
336.00 - 596.00: 19.45 || 17.55 || 72.80</br>
596.00 - 900.00: 16.89 || 15.40 || 83.53</br>
source/bkg ratio</br>
336.00 - 596.00: 0.38 || 0.26 || 1.25</br>
596.00 - 900.00: 0.24 || 0.19 || 1.16</br>
('last region(mid point) to limiting radius ratio: ', '0.70')</br>
The result is written in spectral_region.dat</br>
    
  </span>
</i>
</br></br>

The final result is written in <i>spectral_region.dat</i> in the main folder. This file will be used when making the spectra. I provide the ratio of the mid-point of the last region to the limiting radius. As I said at the beginning, this ratio matters in   <span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">the forward or backward method. </span>
</br>

This is the annuli (in arcsecs) for the source region and CXB. We set the outermost annulus of the source to be 276 arcsecs. And the CXB region begins at 276 + 60 = 336 arcsecs. There are two regions found for the CXB since the criteria is fulfilled. You can modify them manually if you want only one region. Just change  <i>spectral_region.dat</i>.</br></br>

Now let's take a look at  <i>spectral_region.dat</i>:</br></br>

<i>
  <span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:black">
0.0   source</br>
30.0   source</br>
60.0   source</br>
110.0   source</br>
276.0   source</br>
336.0   cxb</br>
596.0   cxb</br>
900.0   cxb</br>
 </span>
</i>
</br></br>

This file tells you what regions are for the source and what regions are for CXB. </br></br>

Before we move on to produce the spectra, if you just want to check the number of counts in a particular radius, do step 4:</br></br>

<i>
  <span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
    python bin/spectral_fit_script.py 4
     </span>
</i>
</br></br>



Then you will be asked to input the inner and outer radius at the prompt, just input the values in arcsecs and you will get the number of counts and S/N ratio for the three ccds.</br></br>



Finally, to produce the spectra, open 3 separate terminals and run the following 3 commands, one for each terminal:</br></br>

<i>
  <span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
    source src/spectra-ann.csh mos1S001 path_to_calibration</br>
    source src/spectra-ann.csh mos2S002 path_to_calibration</br>
    source src/spectra-ann.csh pnS003 path_to_calibration</br></br>
</span>
</i>

The script <i>src/spectra-ann.csh</i> does the following:</br></br>
1) It reads <i>spectral_region.dat</i> and produces the spectrum one by one. A separate folder is created every time and an existing one is deleted. For example, the first spectrum in 0-30 arcsecs, a folder named <i>mos2S002-0-30</i> is created and everything is produced there. </br>
2) The files necessary for producing the spectrum is copied to the folder (i.e. <i>mos2S002-clean.fits, mos2S002-bkg_region-sky.fits, mos2S002-bkg_region-det.fits</i> and the <i>oot</i> files for <i>pn</i>)</br>
3) Since we are not producing the whole FOV spectrum, we need to provide a region. The script writes this file as <i>mos2-0-30.reg</i> (in the folder <i>mos2S002-0-30</i>). Here is the content of <i>mos2-0-30.reg</i>:</br></br>

<i>
  <span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:black">
&&((DETX,DETY) IN circle(232.60537,-57.590704,600))&&!((DETX,DETY) IN circle(232.60537,-57.590704,0))
</span>
</i>

</br></br>

The centre is in detector coordinate and is read from <i>Centre.txt</i> in the main folder. Here the centre is <i>x =  232.6</i> and <i>y = -57.59</i>. <i>600</i> is the outer radius in pixels. Since one pixel = 0.05 arcsrc, 30 arcsecs translate to 600 pixels. The "0" is the inner radius. We work on the area <i>"IN circle(232.60537,-57.590704,600))"</i> but we excluse <i>"IN circle(232.60537,-57.590704,0))"</i>.</br>
4) The following commands are executed:</br></br>

<i>
  <span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
mos-spectra prefix=2S002 caldb=$path_to_calibration region=mos2-0-30.reg mask=1 elow=0 ehigh=0 ccd1=1 ccd2=1 ccd3=1 ccd4=1 ccd5=0 ccd6=1 ccd7=1 >& ../log/mos2-spectra-0-30.log
mos_back prefix=2S002 caldb=$path_to_calibration elow=0 ehigh=0 ccd1=1 ccd2=1 ccd3=1 ccd4=1 ccd5=0 ccd6=1 ccd7=1 >& ../log/mos2_back-0-30.log
</span>
</i>
</br></br>
To decide which ccd chip should be enabled, the file <i>InputFiles/goodccdlist_mos2.dat</i> is read. We set <i>elow=0 ehigh=0</i> to produce the full energy range spectrum. If you only feel interested in a particular energy range, you can select it in the spectral fit when you use <i>XSPEC</i>. </br>

The final products you want are: <i> mos2S002-obj.pi, mos2S002-back.pi, mos2S002.rmf</i> and <i>mos2S002-back.arf</i>. They are necessary for the spectral fit. The script renames them to <i>mos2S002-obj-0-30.pi, mos2S002-back-0-30.pi, mos2S002-0-30.rmf</i> and <i>mos2S002-0-30.arf</i>, respectively, and put them in the main folder.</br></br>

The log files are written as <i>log/mos2-spectra-0-30.log</i> and <i>log/mos2_back-0-30.log</i>. If there is something wrong, check them. And the sub commands for <i> mos-spectra</i> are written in <i>command/mos2-spectra-0-30.csh</i>.</br></br>


To make things faster, you can run all the spectra concurrently by opening multiple windows. Use the script <i>src/spectra-single.csh</i>:</br></br>

<i>
  <span style="font-family: arial; sans-serif; font-size: 12pt; text-align: left; color:red">
    source src/spectra-single.csh mos2S002 path_to_calibration 0 30</br></br>
</span>
</i>

You just add the inner and outer radius in arcsecs and that particular spectrum would be produced.</br></br>



<!--
insert ends
-->

					    
</style></span></p><p class="MsoNormal" style="line-height: 16.866667px;"><span lang="EN-GB" style="font-size: 12pt; line-height: 18.4px;">&nbsp;</span></p>
      
                              

   
 


</body>
</html>

 

 

  

    
 

 
</head>


</html>
